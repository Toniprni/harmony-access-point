<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <!-- properties - to be used in column definitions -->
    <include file="common/changelog-properties-v2.xml" relativeToChangelogFile="true"/>

    <changeSet author="idragusa" id="Partition tables">
        <sql>
            ALTER TABLE TB_USER_MESSAGE MODIFY
            PARTITION BY RANGE (ID_PK) (
            PARTITION P21000000 VALUES LESS THAN (210000000000000000))
            UPDATE INDEXES;
        </sql>

        <sql>
            ALTER TABLE TB_MESSAGE_ACKNW MODIFY
            PARTITION BY REFERENCE ( FK_MSG_ACK_USER_MSG );
        </sql>

        <sql>
            ALTER TABLE TB_MESSAGE_ACKNW_PROP MODIFY
            PARTITION BY REFERENCE ( FK_MSG_ACK_PROP_MSG_ACK );
        </sql>

        <sql>
            ALTER TABLE TB_SJ_MESSAGE_GROUP MODIFY
            PARTITION BY REFERENCE ( FK_MSG_FG_GROUP_UM );
        </sql>

        <sql>
            ALTER TABLE TB_SJ_MESSAGE_FRAGMENT MODIFY
            PARTITION BY REFERENCE ( FK_SJ_MSG_FG_USER_MSG );
        </sql>

        <sql>
            ALTER TABLE TB_USER_MESSAGE_LOG MODIFY
            PARTITION BY REFERENCE ( FK_MSG_LOG_MSG_ID );
        </sql>

        <sql>
            ALTER TABLE TB_PART_INFO MODIFY
            PARTITION BY REFERENCE ( FK_PART_INFO_USER_MSG );
        </sql>

        <sql>
            ALTER TABLE TB_PART_PROPERTIES MODIFY
            PARTITION BY REFERENCE ( FK_PART_PROPS_PART_INFO );
        </sql>

        <sql>
            ALTER TABLE TB_MESSAGE_PROPERTIES MODIFY
            PARTITION BY REFERENCE ( FK_MSG_PROPS_USER_MSG );
        </sql>

        <sql>
            ALTER TABLE TB_USER_MESSAGE_RAW MODIFY
            PARTITION BY REFERENCE ( FK_MSG_RAW_USER_MSG );
        </sql>

        <sql>
            ALTER TABLE TB_SIGNAL_MESSAGE MODIFY
            PARTITION BY REFERENCE ( FK_TB_SIGNAL_USER_MSG );
        </sql>

        <sql>
            ALTER TABLE TB_SIGNAL_MESSAGE_LOG MODIFY
            PARTITION BY REFERENCE ( FK_SIGNAL_LOG_SIGNAL_ID );
        </sql>

        <sql>
            ALTER TABLE TB_RECEIPT MODIFY
            PARTITION BY REFERENCE ( FK_TB_RECEIPT_SIGNAL_MSG );
        </sql>

        <sql>
            ALTER TABLE TB_SIGNAL_MESSAGE_RAW MODIFY
            PARTITION BY REFERENCE ( FK_SIGNAL_MSG_RAW_SIGNAL_MSG );
        </sql>

        <sql>
            ALTER TABLE TB_SEND_ATTEMPT MODIFY
            PARTITION BY REFERENCE ( FK_SEND_ATTEMPT_USER_MSG );
        </sql>

        <sql>
            ALTER TABLE TB_ERROR_LOG MODIFY
            PARTITION BY REFERENCE ( FK_ERROR_LOG_MSG_ID );
        </sql>

        <sql>
            CREATE OR REPLACE FUNCTION generate_partition(p_date IN DATE)
            RETURN NUMBER IS p_id NUMBER;
            BEGIN
            DECLARE
                date_format CONSTANT STRING(10) := 'YYMMDDHH24';
                BEGIN
                    SELECT to_number(to_char(p_date, date_format))
                    INTO p_id
                    FROM dual;
                    RETURN p_id;
                END;
            END;
            /

            set serveroutput on size 30000;
            BEGIN
            DECLARE
                p_id NUMBER;
                p_name VARCHAR2(20);
                p_high NUMBER;
                p_alter VARCHAR2(200);
            BEGIN
                FOR p IN 0 .. 24
                LOOP
                    select generate_partition(sysdate+p/24) into p_id from dual;
                    p_name := 'P'||p_id;
                    p_high := p_id||'0000000000';
                    select 'ALTER TABLE TB_USER_MESSAGE ADD PARTITION ' || p_name || ' VALUES LESS THAN (' || p_high||')' into p_alter from dual;
                    execute immediate p_alter;
                    DBMS_OUTPUT.PUT_LINE(p_alter);
                END LOOP;
            END;
            END;
        </sql>

    </changeSet>

</databaseChangeLog>
