<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <!-- properties - to be used in column definitions -->
    <include file="../common/changelog-properties-v2.xml" relativeToChangelogFile="true"/>

    <!-- drop previously created tables for migration - MIGR_* and TB_D tables -->
    <changeSet id="EDELIVERY-7970" author="Catalin Enache">
        <comment>drop previously created tables for migration - MIGR_* and TB_D tables</comment>
        <dropTable tableName="MIGR_TB_USER_MESSAGE"/>
        <dropTable tableName="MIGR_TB_SIGNAL_MESSAGE"/>

        <dropTable tableName="MIGR_TB_SJ_MESSAGE_FRAGMENT"/>
        <dropTable tableName="MIGR_TB_SJ_MESSAGE_GROUP"/>
        <dropTable tableName="MIGR_TB_SJ_MESSAGE_HEADER"/>

        <dropTable tableName="MIGR_TB_USER_MESSAGE_LOG"/>
        <dropTable tableName="MIGR_TB_SIGNAL_MESSAGE_LOG"/>

        <dropTable tableName="MIGR_TB_USER_MESSAGE_RAW"/>
        <dropTable tableName="MIGR_TB_SIGNAL_MESSAGE_RAW"/>

        <dropTable tableName="MIGR_TB_RECEIPT"/>

        <dropTable tableName="MIGR_TB_MESSAGE_PROPERTIES"/>
        <dropTable tableName="MIGR_TB_PART_INFO"/>
        <dropTable tableName="MIGR_TB_PART_PROPERTIES"/>

        <dropTable tableName="TB_D_MPC"/>
        <dropTable tableName="TB_D_ROLE"/>
        <dropTable tableName="TB_D_SERVICE"/>
        <dropTable tableName="TB_D_AGREEMENT"/>
        <dropTable tableName="TB_D_ACTION"/>
        <dropTable tableName="TB_D_PARTY"/>
        <dropTable tableName="TB_D_MESSAGE_STATUS"/>
        <dropTable tableName="TB_D_NOTIFICATION_STATUS"/>
        <dropTable tableName="TB_D_MESSAGE_PROPERTY"/>
        <dropTable tableName="TB_D_PART_PROPERTY"/>
        <dropTable tableName="TB_D_MSH_ROLE"/>
    </changeSet>

    <!-- Start Dictionary Tables -->
    <changeSet author="Catalin Enache" id="EDELIVERY-7970-recreate-dictionary-tables">
        <createTable tableName="TB_D_MSH_ROLE">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_MSH_ROLE"/>
            </column>
            <column name="ROLE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <addUniqueConstraint columnNames="ROLE" constraintName="UK_D_MSH_ROLE" tableName="TB_D_MSH_ROLE"/>

        <createTable tableName="TB_D_MESSAGE_PROPERTY">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_MSG_PROPERTY"/>
            </column>
            <column name="NAME" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="VALUE" type="VARCHAR(1024)"/>
            <column name="TYPE" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <sql>
            ALTER TABLE TB_D_MESSAGE_PROPERTY ADD CONSTRAINT UK_D_MSG_PROP_NAME UNIQUE (NAME(100), VALUE(100), TYPE(50));
        </sql>

        <createTable tableName="TB_D_PART_PROPERTY">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_PART_PROPERTY"/>
            </column>
            <column name="NAME" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="VALUE" type="VARCHAR(1024)"/>
            <column name="TYPE" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <sql>
            ALTER TABLE TB_D_PART_PROPERTY ADD CONSTRAINT UK_D_PART_PROP_NAME UNIQUE (NAME(100), VALUE(100), TYPE(50));
        </sql>

        <createTable tableName="TB_D_MPC">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_MPC"/>
            </column>
            <column name="VALUE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <addUniqueConstraint columnNames="VALUE" constraintName="UK_D_MPC_VALUE" tableName="TB_D_MPC"/>

        <createTable tableName="TB_D_SERVICE">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_SERVICE"/>
            </column>
            <column name="VALUE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <addUniqueConstraint columnNames="VALUE" constraintName="UK_D_SERVICE_VALUE" tableName="TB_D_SERVICE"/>

        <createTable tableName="TB_D_PARTY">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_PARTY"/>
            </column>
            <column name="VALUE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <addUniqueConstraint columnNames="VALUE" constraintName="UK_D_PARTY_VALUE" tableName="TB_D_PARTY"/>

        <createTable tableName="TB_D_ACTION">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_ACTION"/>
            </column>
            <column name="ACTION" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <addUniqueConstraint columnNames="ACTION" constraintName="UK_D_PARTY_ACTION" tableName="TB_D_ACTION"/>

        <createTable tableName="TB_D_AGREEMENT">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_AGREEMENT"/>
            </column>
            <column name="VALUE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <addUniqueConstraint columnNames="VALUE" constraintName="UK_D_AGREEMENT_VALUE" tableName="TB_D_AGREEMENT"/>

        <createTable tableName="TB_D_ROLE">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_ROLE"/>
            </column>
            <column name="ROLE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <addUniqueConstraint columnNames="ROLE" constraintName="UK_D_ROLE_VALUE" tableName="TB_D_ROLE"/>

        <createTable tableName="TB_D_NOTIFICATION_STATUS">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_NOTIFICATION_STATUS"/>
            </column>
            <column name="STATUS" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <addUniqueConstraint columnNames="STATUS" constraintName="UK_D_NOTIF_STATUS" tableName="TB_D_NOTIFICATION_STATUS"/>

        <createTable tableName="TB_D_MESSAGE_STATUS">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_MESSAGE_STATUS"/>
            </column>
            <column name="STATUS" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>
        <addUniqueConstraint columnNames="STATUS" constraintName="UK_D_MESSAGE_STATUS" tableName="TB_D_MESSAGE_STATUS"/>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7970-recreate-MIGR-tables">
        <createTable tableName="MIGR_TB_USER_MESSAGE">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_USER_MESSAGE"/>
            </column>
            <column name="MESSAGE_ID" type="VARCHAR(255)"/>
            <column name="REF_TO_MESSAGE_ID" type="VARCHAR(255)"/>
            <column name="CONVERSATION_ID" type="VARCHAR(255)"/>
            <column name="SOURCE_MESSAGE" type="BOOLEAN" remarks="true if the message is a SourceMessage"/>
            <column name="MESSAGE_FRAGMENT" type="BOOLEAN" remarks="true if the message is a message fragment"/>
            <column name="TEST_MESSAGE" type="BOOLEAN"/>
            <column name="EBMS3_TIMESTAMP" type="TIMESTAMP"
                    remarks="the EBMS3 timestamp present in eb:Messaging/eb:UserMessage/eb:MessageInfo/eb:Timestamp"/>
            <column name="ACTION_ID_FK" type="BIGINT"/>
            <column name="AGREEMENT_ID_FK" type="BIGINT"/>
            <column name="SERVICE_ID_FK" type="BIGINT"/>
            <column name="MPC_ID_FK" type="BIGINT"/>
            <column name="FROM_PARTY_ID_FK" type="BIGINT"/>
            <column name="FROM_ROLE_ID_FK" type="BIGINT"/>
            <column name="TO_PARTY_ID_FK" type="BIGINT"/>
            <column name="TO_ROLE_ID_FK" type="BIGINT"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>

        <!-- TB_SJ_MESSAGE_FRAGMENT -->
        <createTable tableName="MIGR_TB_SJ_MESSAGE_FRAGMENT">
            <column name="ID_PK" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="PK_MESSAGE_FRAGMENT"/>
            </column>
            <column name="FRAGMENT_NUMBER" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="GROUP_ID_FK" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>


        <!-- TB_SIGNAL_MESSAGE -->
        <createTable tableName="MIGR_TB_SIGNAL_MESSAGE">
            <column name="ID_PK" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="PK_SIGNAL_MESSAGE"/>
            </column>
            <column name="SIGNAL_MESSAGE_ID" type="VARCHAR(255)"/>
            <column name="REF_TO_MESSAGE_ID" type="VARCHAR(255)"/>
            <column name="EBMS3_TIMESTAMP" type="TIMESTAMP" remarks="the EBMS3 timestamp present in eb:Messaging/eb:UserMessage/eb:MessageInfo/eb:Timestamp"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)"/>
        </createTable>


    </changeSet>
</databaseChangeLog>